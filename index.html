<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Pro - Froylan</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Estilos base para etiquetas */
        .input-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: #9ca3af; /* gray-400 */
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }
        
        /* CORRECCIÓN PRINCIPAL: Inputs con fondo blanco y texto negro */
        .input-field {
            width: 100%;
            background-color: #ffffff; /* Fondo blanco */
            color: #111827; /* Texto casi negro */
            border: 1px solid #d1d5db; /* Borde gris claro */
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .input-field:focus {
            border-color: #3b82f6; /* Azul al enfocar */
            ring: 2px solid #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-blue-400">Simulador Pro</h1>
                <p class="text-gray-400 text-xs md:text-sm">Proyección de Patrimonio</p>
            </div>
            <button onclick="generatePDF()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded shadow flex items-center gap-2 transition text-sm font-bold">
                <i class="fa-solid fa-file-pdf"></i> Guardar PDF
            </button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-1 bg-gray-800 p-5 rounded-xl shadow-lg h-fit">
                <h2 class="text-lg font-semibold mb-4 text-gray-200 border-l-4 border-blue-500 pl-2">Configuración</h2>
                
                <form id="simForm" onsubmit="event.preventDefault(); calculate();" class="space-y-4">
                    
                    <div>
                        <label class="input-label">Capital Inicial (USD)</label>
                        <input type="number" id="initialCapital" class="input-field" value="5800">
                    </div>

                    <div>
                        <label class="input-label">Aporte Mensual (USD)</label>
                        <input type="number" id="monthlyContrib" class="input-field" value="300">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="input-label">Aporte Extra</label>
                            <input type="number" id="extraContrib" class="input-field" value="1000">
                        </div>
                        <div>
                            <label class="input-label">Frecuencia</label>
                            <select id="extraFreq" class="input-field cursor-pointer">
                                <option value="0">Ninguno</option>
                                <option value="2">Bimensual</option>
                                <option value="3">Trimestral</option>
                                <option value="6">Semestral</option>
                                <option value="12" selected>Anual</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-gray-700/30 p-3 rounded border border-gray-600">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="dynamicContrib" class="w-4 h-4" checked onchange="toggleIncrease()">
                            <label for="dynamicContrib" class="text-sm text-gray-200 cursor-pointer select-none">Aumentar aportes cada año</label>
                        </div>
                        <div id="increaseGroup">
                            <label class="input-label">Tasa de Aumento (%)</label>
                            <input type="number" id="contribIncreaseRate" class="input-field" value="5">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="input-label">Crecimiento (%)</label>
                            <input type="number" id="priceAppreciation" class="input-field" value="8" step="0.1">
                        </div>
                        <div>
                            <label class="input-label">Dividend Yield (%)</label>
                            <input type="number" id="dividendYield" class="input-field" value="2.5" step="0.1">
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="reinvestDivs" class="w-4 h-4 text-green-500 rounded" checked>
                        <label for="reinvestDivs" class="text-sm text-gray-300 cursor-pointer select-none">Reinvertir Dividendos</label>
                    </div>

                    <div>
                        <label class="input-label">Duración (Años)</label>
                        <input type="number" id="years" class="input-field" value="15">
                    </div>

                    <button type="button" onclick="calculate()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg transition active:scale-95 mt-2">
                        CALCULAR AHORA
                    </button>
                </form>
            </div>

            <div class="lg:col-span-2 space-y-6">
                
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="bg-gray-800 p-4 rounded-lg border-t-4 border-blue-500 shadow">
                        <p class="text-gray-400 text-xs uppercase font-bold">Valor Final</p>
                        <p class="text-2xl font-bold text-white mt-1" id="resFinalValue">$0</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg border-t-4 border-green-500 shadow">
                        <p class="text-gray-400 text-xs uppercase font-bold">Dividendo Anual</p>
                        <p class="text-2xl font-bold text-green-400 mt-1" id="resAnnualDiv">$0</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg border-t-4 border-purple-500 shadow">
                        <p class="text-gray-400 text-xs uppercase font-bold">Total Aportado</p>
                        <p class="text-2xl font-bold text-purple-300 mt-1" id="resTotalInvested">$0</p>
                    </div>
                </div>

                <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
                    <div class="h-64 md:h-80 w-full relative">
                        <canvas id="growthChart"></canvas>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden border border-gray-700">
                    <div class="p-3 bg-gray-700/50 border-b border-gray-600 flex justify-between items-center">
                        <span class="font-bold text-sm text-gray-200">Desglose (Primeros y últimos años)</span>
                        <span class="text-xs text-gray-500 italic">*Ver todo en PDF</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-300">
                            <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                                <tr>
                                    <th class="px-4 py-3">Año</th>
                                    <th class="px-4 py-3">Aportado</th>
                                    <th class="px-4 py-3">Valor Total</th>
                                    <th class="px-4 py-3 text-right">Dividendos</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="divide-y divide-gray-700">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let myChart = null;
        let simulationData = {};

        // Formateador de moneda seguro
        const USD = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            maximumFractionDigits: 0
        });

        // Función auxiliar para visibilidad del input de incremento
        function toggleIncrease() {
            const check = document.getElementById('dynamicContrib');
            const group = document.getElementById('increaseGroup');
            if(check.checked) {
                group.style.opacity = "1";
                group.style.pointerEvents = "auto";
            } else {
                group.style.opacity = "0.5";
                group.style.pointerEvents = "none";
            }
        }

        // Lógica Principal
        function calculate() {
            console.log("Iniciando cálculo..."); // Debug en consola

            // 1. Obtener valores (con valores por defecto seguros)
            const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
            
            let principal = getVal('initialCapital');
            let monthly = getVal('monthlyContrib');
            let extraAmount = getVal('extraContrib');
            let extraFreq = parseInt(document.getElementById('extraFreq').value);
            
            let increaseActive = document.getElementById('dynamicContrib').checked;
            let increaseRate = getVal('contribIncreaseRate') / 100;
            
            let priceAppreciation = getVal('priceAppreciation') / 100;
            let divYield = getVal('dividendYield') / 100;
            let reinvest = document.getElementById('reinvestDivs').checked;
            let years = parseInt(document.getElementById('years').value) || 1;

            // Arrays
            let labels = [];
            let portfolioCurve = [];
            let investedCurve = [];
            let spyCurve = [];
            let safeCurve = [];
            let dividendData = [];

            // Variables de estado
            let currentBalance = principal;
            let totalInvested = principal;
            let spyBalance = principal;
            let safeBalance = principal;

            let months = years * 12;
            let currentYear = 1;

            // Bucle mes a mes
            for (let m = 1; m <= months; m++) {
                // Interés mensual
                currentBalance *= (1 + priceAppreciation/12);
                
                // Dividendos
                let monthlyDiv = currentBalance * (divYield/12);
                if (reinvest) currentBalance += monthlyDiv;

                // Aportes
                currentBalance += monthly;
                totalInvested += monthly;
                
                // Benchmarks
                spyBalance = (spyBalance * (1 + 0.10/12)) + monthly;
                safeBalance = (safeBalance * (1 + 0.05/12)) + monthly;

                // Aporte Extra
                if (extraFreq > 0 && m % extraFreq === 0) {
                    currentBalance += extraAmount;
                    totalInvested += extraAmount;
                    spyBalance += extraAmount;
                    safeBalance += extraAmount;
                }

                // Cierre de Año
                if (m % 12 === 0) {
                    labels.push(`Año ${currentYear}`);
                    portfolioCurve.push(currentBalance);
                    investedCurve.push(totalInvested);
                    spyCurve.push(spyBalance);
                    safeCurve.push(safeBalance);
                    dividendData.push(currentBalance * divYield); // Div proyectado anual

                    // Incremento anual de aportes
                    if (increaseActive) {
                        monthly *= (1 + increaseRate);
                        extraAmount *= (1 + increaseRate);
                    }
                    currentYear++;
                }
            }

            // Guardar datos globales
            simulationData = {
                labels, portfolioCurve, investedCurve, dividendData,
                finalValue: currentBalance,
                finalInvested: totalInvested
            };

            // Actualizar DOM Texto
            document.getElementById('resFinalValue').innerText = USD.format(currentBalance);
            document.getElementById('resTotalInvested').innerText = USD.format(totalInvested);
            document.getElementById('resAnnualDiv').innerText = USD.format(currentBalance * divYield);

            // Actualizar Tabla y Gráfico
            renderTable(labels, investedCurve, portfolioCurve, dividendData);
            renderChart(labels, portfolioCurve, spyCurve, safeCurve);
        }

        function renderTable(labels, invested, portfolio, dividends) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            // Mostrar solo primeros 3 años, intermedios y ultimos 3 si es muy largo
            let indicesToShow = new Set([0, 1, 2, labels.length-1, labels.length-2, labels.length-3]);
            // Agregar algunos intermedios
            if(labels.length > 10) indicesToShow.add(Math.floor(labels.length/2));

            labels.forEach((label, i) => {
                if (!indicesToShow.has(i) && labels.length > 15) return; // Saltar para no saturar si es muy largo

                let row = `
                    <tr class="hover:bg-gray-700 transition-colors">
                        <td class="px-4 py-3 font-medium text-white">${label}</td>
                        <td class="px-4 py-3 text-gray-400">${USD.format(invested[i])}</td>
                        <td class="px-4 py-3 text-blue-300 font-bold">${USD.format(portfolio[i])}</td>
                        <td class="px-4 py-3 text-right text-green-400 font-mono">${USD.format(dividends[i])}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function renderChart(labels, user, spy, safe) {
            const ctx = document.getElementById('growthChart').getContext('2d');
            
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Tu Portafolio',
                            data: user,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.15)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'S&P 500 (10%)',
                            data: spy,
                            borderColor: '#9ca3af',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#e5e7eb' } },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#e5e7eb',
                            borderColor: '#374151',
                            borderWidth: 1,
                            callbacks: {
                                label: (c) => ` ${c.dataset.label}: ${USD.format(c.raw)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: '#374151' },
                            ticks: { color: '#9ca3af', callback: v => '$' + v/1000 + 'k' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#9ca3af' }
                        }
                    }
                }
            });
        }

        // Generador PDF
        async function generatePDF() {
            if (!simulationData.labels) calculate();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Encabezado PDF
            doc.setFillColor(30, 41, 59); // Fondo oscuro header
            doc.rect(0, 0, 210, 40, 'F');
            doc.setFontSize(22);
            doc.setTextColor(255, 255, 255);
            doc.text("Reporte de Inversión", 14, 20);
            doc.setFontSize(10);
            doc.setTextColor(209, 213, 219);
            doc.text(`Generado: ${new Date().toLocaleDateString()}`, 14, 28);

            // Resumen KPI
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.text(`Valor Final Proyectado: ${USD.format(simulationData.finalValue)}`, 14, 55);
            doc.text(`Capital Total Invertido: ${USD.format(simulationData.finalInvested)}`, 14, 62);

            // Tabla
            const rows = simulationData.labels.map((l, i) => [
                l, 
                USD.format(simulationData.investedCurve[i]),
                USD.format(simulationData.portfolioCurve[i]),
                USD.format(simulationData.dividendData[i])
            ]);

            doc.autoTable({
                startY: 70,
                head: [['Año', 'Aportado', 'Patrimonio', 'Dividendos']],
                body: rows,
                theme: 'striped',
                headStyles: { fillColor: [59, 130, 246] }, // Azul
                alternateRowStyles: { fillColor: [243, 244, 246] }
            });

            doc.save('Simulacion_Financiera.pdf');
        }

        // Ejecutar al cargar la página
        window.onload = function() {
            calculate();
        };
    </script>
</body>
</html>
